language: rust
rust:
  - stable
  - beta
  - nightly

cache: cargo
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

addons:
  apt:
    packages:
      - libdbus-1-dev
      - gnome-keyring
      - python3

before_script:
  - git clone https://gitlab.gnome.org/GNOME/libsecret.git

script:
    if [ "$TRAVIS_OS_NAME" = "linux" ]; then dbus-run-session -- python3 ci/run_mock.py libsecret/libsecret/mock-service-normal.py & cargo build --verbose; else cargo build --verbose && RUST_TEST_THREADS=1 cargo test --verbose; fi

matrix:
  allow_failures:
    - rust: nightly